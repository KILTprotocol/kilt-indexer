# SubQuery - Example Project for Kilt Spiritnet

[SubQuery](https://subquery.network) is a fast, flexible, and reliable open-source data indexer that provides you with custom APIs for your web3 project across all of our supported networks. To learn about how to get started with SubQuery, [visit our docs](https://academy.subquery.network).

**This SubQuery project indexes all attestations and daily aggregations on the Kilt Spiritnet Network**

## Start

First, install SubQuery CLI globally on your terminal by using NPM `npm install -g @subql/cli`

You can either clone this GitHub repo, or use the `subql` CLI to bootstrap a clean project in the network of your choosing by running `subql init` and following the prompts.

Don't forget to install dependencies with `npm install` or `yarn install`!

## Editing your SubQuery project

Although this is a working example SubQuery project, you can edit the SubQuery project by changing the following files:

- The project manifest in `project.yaml` defines the key project configuration and mapping handler filters.
  `project.yaml` is autogenerated from `project.ts.`
- The GraphQL Schema (`schema.graphql`) defines the shape of the resulting data that you are using SubQuery to index
- The Mapping functions in `src/mappings/` directory are typescript functions that handle transformation logic

SubQuery supports various layer-1 blockchain networks and provides [dedicated quick start guides](https://academy.subquery.network/quickstart/quickstart.html) as well as [detailed technical documentation](https://academy.subquery.network/build/introduction.html) for each of them.

## Run your project

_If you get stuck, find out how to get help below._

The simplest way to run your project is by running `yarn dev` or `npm run-script dev`. This does all of the following:

1.  `yarn codegen` - Generates types from the GraphQL schema definition and contract ABIs and saves them in the `/src/types` directory. This must be done after each change to the `schema.graphql` file or the contract ABIs
2.  `yarn build` - Builds and packages the SubQuery project into the `/dist` directory
3.  `yarn start:docker` alias to `docker-compose pull && docker-compose up` - Runs a Docker container with an indexer, PostgeSQL DB, and a query service. This requires [Docker to be installed](https://docs.docker.com/engine/install) and running locally. The configuration for this container is set from your `docker-compose.yml`

You can observe the three services start, and once all are running (it may take a few minutes on your first start), please open your browser and head to [http://localhost:3000](http://localhost:3000) - you should see a GraphQL playground showing with the schemas ready to query. [Read the docs for more information](https://academy.subquery.network/run_publish/run.html) or [explore the possible service configuration for running SubQuery](https://academy.subquery.network/run_publish/references.html).

If you change `schema.graphql`, `project.ts` or `mappingHandlers.ts` all autogenerated files during `yarn dev` will be overwritten, with the big exception of the database inside `.data/`.
If you make incompatible changes to any of those files, make sure you delete `.data/` before running `yarn dev`. After making changes to `schema.graphql` you defenitly need to renew your data base.

Additionally, you can run `yarn slash` to delete all autogenerated files at once, including the database.

## Development notes:

Often while trying to develop a new feature the data base of the whole blockchain is not needed.
It is possible to manually set a start and end block for the data base, via environment constants on the `.env`-file.

There are some instructions on how to use them inside the `.env.example`-file, but it is appropriate to add some information about them here.

- **START_BLOCK**: Allows starting your data base from a higher block.
  It only has an effect if there is no current data base `.data/`.

      A lot of actions on the chain depend on previous events; for example to claim a web3name first the DID musst have been created.
      The handlers that process this events and turn them into data base entries know this and will normally throw if they can't find the correspondent dependencies on the data base.
      When a handler throws the building of the data base will stop (the project will try again a couple of times and then crash).
      While this behavior is great for the end product, it impedes you from setting a higher block as starting point; for example if the DID was created in a block before the start block, but the web3name claim afterwards.

      To bypass this behaviors and be able to use a higher starting block some workarounds were implemented.
      They all basically add the missing dependencies as they are needed but with fake values.
      This fake entries are consistently refer as ***prehistoric***, they use the block from the moment of inclusion an fill any unknown values with the `UNKNOWN` constant inside `mappingHandlers.ts`.
      
      _All this workarounds should be remove before deploying the final product_, but have shown very helpful during the development. 
      They save a lot of time, especially while working with the testnet Kilt Peregrine that currently only disposes slower nodes.

- **CUTOFF_HEIGHT**: Sets a target or end block.
  If there is an existing data base with blocks higher than it, they will be removed.
  Useful to reprocess some blocks without renewing your entire data base.
  Please, check instructions for this on the `.env.example`-file.

## Publish your project

SubQuery is open-source, meaning you have the freedom to run it in the following three ways:

- Locally on your own computer (or a cloud provider of your choosing), [view the instructions on how to run SubQuery Locally](https://academy.subquery.network/run_publish/run.html)
- By publishing it to our enterprise-level [Managed Service](https://managedservice.subquery.network), where we'll host your SubQuery project in production ready services for mission critical data with zero-downtime blue/green deployments. We even have a generous free tier. [Find out how](https://academy.subquery.network/run_publish/publish.html)
- [Coming Soon] By publishing it to the decentralized [SubQuery Network](https://subquery.network/network), the most open, performant, reliable, and scalable data service for dApp developers. The SubQuery Network indexes and services data to the global community in an incentivised and verifiable way

## What Next?

Take a look at some of our advanced features to take your project to the next level!

- [**Multi-chain indexing support**](https://academy.subquery.network/build/multi-chain.html) - SubQuery allows you to index data from across different layer-1 networks into the same database, this allows you to query a single endpoint to get data for all supported networks.
- [**Dynamic Data Sources**](https://academy.subquery.network/build/dynamicdatasources.html) - When you want to index factory contracts, for example on a DEX or generative NFT project.
- [**Project Optimisation Advice**](https://academy.subquery.network/build/optimisation.html) - Some common tips on how to tweak your project to maximize performance.
- [**GraphQL Subscriptions**](https://academy.subquery.network/run_publish/subscription.html) - Build more reactive front end applications that subscribe to changes in your SubQuery project.

## Need Help?

The fastest way to get support is by [searching our documentation](https://academy.subquery.network), or by [joining our discord](https://discord.com/invite/subquery) and messaging us in the `#technical-support` channel.

To get more logs while debugging go to `docker-compose.yml` and uncomment `- --log-level=trace`.

## For Queries:

For this project, you can visit the playground under http://localhost:3000/ and try to query one of the following GraphQL codes to get a taste of how it works.

To help you explore the different possible queries and entities, you can draw the documentation on the right of the GraphQL playground.

Most of the example queries below take advantage of the example fragments.
You need to add the fragments to the playground as well, if you want to run queries using those fragments.

_Tip: Commas are irrelevant._

### Useful example Fragments:

GraphQL provides reusable units called _fragments_.
Fragments let you construct sets of fields, and then include them in queries where you need to.

```
fragment wholeBlock on Block{
  id,
  hash,
  timeStamp,
}
```

```
fragment wholeAttestation on Attestation {
  id,
  claimHash,
  cTypeId,
  attester,
  payer,
  delegationID,
  valid,
  creationBlock {
    ...wholeBlock,
  },
  revocationBlock  {
    ...wholeBlock,
  },
  removalBlock {
    ...wholeBlock,
  },
}
```

### Query Examples:

1. **Find Attestation by its claim hash:**

   - _without using fragments:_

   ```
   query {
     attestations(
       filter: {
         claimHash: {
           equalTo: "0x7554dc0b69be9bd6a266c865a951cae6a168c98b8047120dd8904ad54df5bb08"
         }
       }
     ) {
       totalCount
       nodes {
         id
         claimHash
         cTypeId
         attester
         payer
         delegationID
         valid
         creationBlock {
           id
           hash
           timeStamp
         }
       }
     }
   }

   ```

   - _taking advantage of fragments:_

   ```
   query {
     attestations(
       filter: {
         claimHash: {
           equalTo: "0x7554dc0b69be9bd6a266c865a951cae6a168c98b8047120dd8904ad54df5bb08"
         }
       }
     ) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

2. **Find all revoked attestations:**

   ```
   query {
     attestations(filter: { revocationBlockId: { isNull: false } }) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

3. **Find how many attestations were made on a block:**

   ```
   query {
     blocks(filter: { id: { equalTo: "3396407" } }) {
       # Queries can have comments!
       nodes {
         id
         timeStamp
         hash
         attestationsByCreationBlockId {
           totalCount
           nodes {
             id
             cTypeId
             claimHash
             attester
           }
         }
       }
     }
   }
   ```

4. **Find all cTypes that have been used at least once:**

   ```
   query {
     cTypes(
       filter: { attestations: { some: { id: { isNull: false } } } }
       orderBy: ATTESTATIONS_COUNT_DESC
     ) {
       totalCount
       nodes {
         id
         author
         registrationBlock {
           ...wholeBlock
         }
         attestationsCreated
         attestationsRevoked
         attestationsRemoved
         validAttestations
         attestations(orderBy: ID_ASC) {
           totalCount
           nodes {
             ...wholeAttestation
           }
         }
       }
     }
   }
   ```

5. **Find all cTypes created during the second million blocks:**

   ```
   query {
     cTypes(
       filter: {
         registrationBlockId: {
           greaterThanOrEqualTo: "1000000"
           lessThanOrEqualTo: "2000000"
         }
       }
     ) {
       totalCount
       nodes {
         id
         author
         registrationBlock {
           ...wholeBlock
         }
         attestationsCreated
         validAttestations
       }
     }
   }
   ```

6. **Find all attestation revoked during October 2023:**

   ```
   query {
     attestations(
       filter: {
         revocationBlock: {
           timeStamp: { greaterThan: "2023-9-30", lessThan: "2023-11-1" }
         }
       }
       orderBy: ID_ASC
     ) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

7. **Find DID bearer of w3n:alice and since when:**

   ```
    query {
      dids(filter: { web3NameId: { equalTo: "w3n:alice" } }) {
        nodes {
          id
          payer
          creationBlock {
            id
            timeStamp
          }
          deletionBlockId
          web3NameId
          bearers {
            nodes {
              id
              claimBlock {
                id
                timeStamp
              }
            }
          }
        }
      }
    }
   ```

8. **Find registered data about banned web3names:**

   ```
    query {
      web3Names(filter: { banned: { equalTo: true } }) {
        totalCount
        nodes {
          id
          banned
          bearers {
            totalCount
            nodes {
              id
              didId
              claimBlockId
              releaseBlockId
            }
          }

          sanctionsByNameId {
            totalCount
            nodes {
              id
              nameId
              nature
              enforcementBlockId
            }
          }
        }
      }
    }
   ```
