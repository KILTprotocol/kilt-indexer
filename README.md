# KILT Indexer

This KILT Indexer project builds a customized database with information from the **[KILT Blockchain](https://www.kilt.io/)** , leveraging the robust capabilities of [SubQuery](https://subquery.network) as its backbone.
This Indexer tailors the generic framework provided by SubQuery for **collecting, processing, and storing data from chain node interaction**s.
The processed data is made available for customers to query via a website or HTTP requests.

The majority of the information collected focuses on **Identity solutions** rather than transactions.
This includes data related to [decentralized identifiers (DIDs)](https://docs.kilt.io/docs/concepts/did) and [verifiable credentials (VCs)](https://docs.kilt.io/docs/concepts/credentials/overview).

You can visit our deployed websites to query information.
It is also possible to run the indexer locally, allowing you to customize it to your needs.

## Deployed Versions

You can interact with our public GraphQL Servers via the Playgrounds deployed under following links:

- To query data from the **KILT production Blockchain**, aliased **_Spiritnet_**, visit: https://indexer.kilt.io/
- To query data from the **KILT development Blockchain**, aliased **_Peregrine_**, visit: https://dev-indexer.kilt.io/

# Getting started

## Steps to launch locally

1. [Clone repository and **install** all necessary modules.](#Installation)
2. [Define your **environment variables**](#Environment-Variables)
3. [**Run the Indexer**](#Run-the-Project)

## Prerequisites

Make sure you installed these requiered software before running this project:

- [Node.js](https://nodejs.org/en/download/prebuilt-installer)
- [Yarn](https://yarnpkg.com/getting-started/install)
- [PostgreSQL](https://www.postgresql.org/download/)
- [Docker](https://docs.docker.com/engine/install/)

## Installation

After [cloning the repository](https://docs.github.com/en/repositories/creating-and-managing-repositories/cloning-a-repository), to install all required modules, run:

- `yarn install`.

## Environment Variables

**You actually do not need to define any environment variables to run this project.**

There are default values for all of the environment variables.
Nevertheless, you can use other values by assigning them inside the `.env`-file.

On the root directory of this repository, there is an `.env.example`-file that list how your variables should be named and what is their use.
The `.env`-file should be added to the same level (directory) where `.env.example`-file is found.

## Run the Project

_First make sure your docker daemon is running._

The simplest way to run your project is by running `yarn dev` or `npm run-script dev`.
This command sequentially executes three steps in a row.
Each of these steps can also be executed independently using the following commands:

1.  `yarn codegen`
    - Generates types from the GraphQL schema definition and saves them in the `/src/types` directory.
    - This must be done after each change to the `schema.graphql` file.
2.  `yarn build`
    -     Builds and packages the SubQuery project into the `/dist` directory
3.  `yarn start:docker`
    -     It's an alias to `docker-compose pull && docker-compose up`.
    - **Fetches and runs** three Docker containers: an **indexer**, a **PostgeSQL DataBase**, and a **query service**.
    - The `docker-compose.yml` file manages this Docker Compose application, orchestrating the various containers needed for the project.
      It specifies wich images to pull and configures how to (re)start the services.
    - This [requires](#Prerequisites) Docker to be running locally.

You can observe the three services start (it may take a few minutes on your first start). Once all are running, you can head to http://localhost:3000 on your browser and you should see a [GraphQL Playground](https://academy.subquery.network/indexer/run_publish/query/graphql.html) showing with the schemas ready to query.

_If you change `schema.graphql`, `project.ts` or `mappingHandlers.ts` all **autogenerated files** during `yarn dev` **will be overwritten, with the big exception of the database** inside `.data/`._
If you make incompatible changes to any of those files, make sure you delete `.data/` before running `yarn dev` again.
After making changes to `schema.graphql` you definitely need to renew your database.

Additionally, you can run `yarn slash` to delete all autogenerated files at once, including the database.

# Editing your Indexer

_We recommend you to fork this repository to your personal 'git' before doing any changes._
_We would love to see any improvemet suggestions comming from the community in the form of Pull Requests._

On top of this working SubQuery project, you can add customizations it by changing the following files:

- The project manifest `project.yaml`:
  - This defines the key project configuration and mapping handler filters.
  - `project.yaml` is autogenerated from `project.ts` wich consumes the environment variables.
- The GraphQL Schema `schema.graphql`:
  - That defines the shape of the resulting data being indexed.
  - It defines the data models for the database.
- The Mapping directory `src/mappings/`:
  - Contains typescript functions that handle transformation logic from chain information to database entries.
  - Defines the mapping handlers listed on the project manifest.

## Need Help?

To get more logs while debugging go to `docker-compose.yml` and uncomment `- --log-level=trace`.

We recommend going through to the documentation of:

- [SubQuery](https://academy.subquery.network)
- [GraphQl](https://graphql.org/learn/)
- [KILT](https://docs.kilt.io/)

You can get support from SubQuery, by [joining the SubQuery discord](https://discord.com/invite/subquery) and messaging in the `#technical-support` channel.

For support from KILT, you can [join the KILT Telegram chat](https://t.me/KILTProtocolChat) or [join the Kilt discord](https://discord.com/invite/HztRqvzbhG) and message us.

# For Queries

For this project, you can visit the playground under http://localhost:3000/ and try to query one of the following GraphQL codes to get a taste of how it works.

To help you explore the different possible queries and entities, you can draw the documentation on the right of the GraphQL playground.

Most of the example queries below take advantage of the example fragments.
You need to add the fragments to the playground as well, if you want to run queries using those fragments.

_Tip: Commas are irrelevant._

## Useful example Fragments

GraphQL provides reusable units called _fragments_.
Fragments let you construct sets of fields, and then include them in queries where needed.

```
fragment wholeBlock on Block{
  id,
  hash,
  timeStamp,
}
```

```
fragment wholeAttestation on Attestation {
  id,
  claimHash,
  cTypeId,
  issuerId,
  payer,
  delegationID,
  valid,
  creationBlock {
    ...wholeBlock,
  },
  revocationBlock  {
    ...wholeBlock,
  },
  removalBlock {
    ...wholeBlock,
  },
}
```

## Query Examples:

1. **Find Attestation by its claim hash:**

   - _without using fragments:_

   ```
   query {
     attestations(
       filter: {
         claimHash: {
           equalTo: "0x7554dc0b69be9bd6a266c865a951cae6a168c98b8047120dd8904ad54df5bb08"
         }
       }
     ) {
       totalCount
       nodes {
         id
         claimHash
         cTypeId
         issuerId
         payer
         delegationID
         valid
         creationBlock {
           id
           hash
           timeStamp
         }
       }
     }
   }

   ```

   - _taking advantage of fragments:_

   ```
   query {
     attestations(
       filter: {
         claimHash: {
           equalTo: "0x7554dc0b69be9bd6a266c865a951cae6a168c98b8047120dd8904ad54df5bb08"
         }
       }
     ) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

2. **Find all revoked attestations:**

   ```
   query {
     attestations(filter: { revocationBlockId: { isNull: false } }) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

3. **Find how many attestations were made on a block:**

   ```
   query {
     blocks(filter: { id: { equalTo: "3396407" } }) {
       # Queries can have comments!
       nodes {
         id
         timeStamp
         hash
         attestationsByCreationBlockId {
           totalCount
           nodes {
             id
             cTypeId
             claimHash
             issuerId
           }
         }
       }
     }
   }
   ```

4. **Find all cTypes that have been used at least once:**

   ```
   query {
     cTypes(
       filter: { attestations: { some: { id: { isNull: false } } } }
       orderBy: ATTESTATIONS_COUNT_DESC
     ) {
       totalCount
       nodes {
         id
         author
         registrationBlock {
           ...wholeBlock
         }
         attestationsCreated
         attestationsRevoked
         attestationsRemoved
         validAttestations
         attestations(orderBy: ID_ASC) {
           totalCount
           nodes {
             ...wholeAttestation
           }
         }
       }
     }
   }
   ```

5. **Find all cTypes created during the second million blocks:**

   ```
   query {
     cTypes(
       filter: {
         registrationBlockId: {
           greaterThanOrEqualTo: "1000000"
           lessThanOrEqualTo: "2000000"
         }
       }
     ) {
       totalCount
       nodes {
         id
         author
         registrationBlock {
           ...wholeBlock
         }
         attestationsCreated
         validAttestations
       }
     }
   }
   ```

6. **Find all attestation revoked during October 2023:**

   ```
   query {
     attestations(
       filter: {
         revocationBlock: {
           timeStamp: { greaterThan: "2023-9-30", lessThan: "2023-11-1" }
         }
       }
       orderBy: ID_ASC
     ) {
       totalCount
       nodes {
         ...wholeAttestation
       }
     }
   }
   ```

7. **Find DID bearer of w3n:alice and since when:**

   ```
   query {
     dids(filter: { web3NameId: { equalTo: "w3n:alice" } }) {
       nodes {
         id
         payer
         creationBlock {
           id
           timeStamp
         }
         deletionBlockId
         web3NameId
         ownershipsByBearerId {
           nodes {
             id
             claimBlock {
               id
               timeStamp
             }
             releaseBlockId
           }
         }
       }
     }
   }

   ```

8. **Find registered data about banned web3names:** (It has never happened on KILT Spiritnet)

   ```
   query {
     web3Names(filter: { banned: { equalTo: true } }) {
       totalCount
       nodes {
         id
         banned
         ownerships {
           totalCount
           nodes {
             id
             bearerId
             claimBlockId
             releaseBlockId
           }
         }

         sanctionsByNameId {
           totalCount
           nodes {
             id
             nameId
             nature
             enforcementBlockId
           }
         }
       }
     }
   }
   ```

9. **Find out who has ever owned w3n:john_doe and when:**

   ```
   query {
    web3Names(filter: { id: { equalTo: "w3n:john_doe" } }) {
      nodes {
        id
        banned
        ownerships(orderBy: ID_ASC) {
          totalCount
          nodes {
            id
            bearerId
            claimBlockId
            releaseBlockId
          }
        }
      }
    }
   }
   ```

10. **Get all Public Credentials and its corresponding Updates:**
    ```
    query {
      publicCredentials {
        totalCount
        nodes {
          id
          subjectId
          claims
          cTypeId
          issuerId
          valid
          updates(orderBy: ID_ASC) {
            totalCount
            nodes {
              id
              nature
              updateBlockId
            }
          }
        }
      }
    }
    ```
